---
title: 浅析前端鉴权
date: 2022-07-26 19:45:46
tags: 前端
---

##### 写在前面

我们都知道 http 是无状态的，上一次请求和下一次请求没有关联。但是很多时候是需要状态来识别用户的，比如一些个人信息如收藏夹、购物车等

下面会讨论三种鉴权的方案：

- session + cookie
- token
- JWT

<!-- more -->

### 服务端存储的 session + cookie

session 是基于 cookie 实现，session 存在服务端，sessionId 则存储在客户端的 cookie 中

![figure](1.png)

如图：请求自动带上 cookie，两次请求都可以找到 id 为 1 对应的 session

**问题**

- CSRF：请求时自动带上 cookie，如果钓鱼网站有一个你已登陆过的网站的链接按钮，点击后 cookie 依然能带上
- 分布式 session：session 把状态保存在服务端，当并发量高了，单台服务器承受不了，多台服务器就出现了 session 同步的问题：一种是 session 复制，每次修改都同步；一种是把 session 保存在 redis
- 跨域：cookie 为了安全，限制了 domain。（注意：CORS 的 Access-Control-Allow-Origin 如果是 \* 也不会携带，必须是具体域名

**总结**

session + cookie 给 http 添加状态的方案是服务端保存 session 数据，然后把 id 放入 cookie 返回，cookie 是自动携带的，每个请求可以通过 cookie 的 id 查找到对应的 session，从而实现请求的标识。但是有 CSRF、分布式 session、跨域的问题

### 客户端存储的 token

token 存储在 cookie 或 localStorage，请求服务端时手动携带在 header

![figure](2.png)

简单的 token 组成：

- uid
- time
- sign（签名，token 的前几位以哈希算法压缩而成的一定长度的十六进制字符串

token 分为 access token 和 refresh token：
access token：每次请求携带的令牌，作为访问资源接口的凭证，一般过期时间比较短
refresh token：专用于刷新 access token 的 token，刷新后的新 access token 需要重新储存在客户端。一般过期时间比较长，如果二者均过期了则需要重新鉴权。

解决了 session + cookie 的三个问题：

- CSRF：不是通过 cookie 储存，因此绕过
- 分布式 session：任何一台服务器能解析 token 即可
- 跨域：同 CSRF

**总结**

客户端使用用户名和密码请求登录，服务端返回 access token 和 refresh token。access token 作为访问资源接口的凭证，每次请求都会携带，一般过期时间比较短。refresh token 专用用于刷新过期的 access token：如果 refresh token 未过期，服务端返回新的 access token；反之，需要客户端重新走一遍鉴权。解决了 session + cookie 的三个问题

### 客户端存储的 JWT（JSON web token）

JWT 本质也是 token
JWT 是保存在 request header 里的一段字符串（header：authorization，分三部分：

header、payload、signature，三部分别分做 base64 加密，然后通过 '.' 连接

```jsx
authorization: barer xxxxx.xxxxx.xxxx
```

![figure](3.png)

- header 保存当前的加密算法和 type，一般是 HS256
- payload 保存具体需要存储的数据
- signature 保存 header 和 payload 还有 salt 加密后的数值

请求时把 authorization 带上，服务端就可以解析出对应的 header payload signature，根据 header 的算法对 header payload 加上 salt 做一次加密，如果得出的结果和 signature 一样，就接收这个 token。

这种方案也解决了 session + cookie 的三个问题（同第二中方案：token

**问题**

- 安全性：JWT 把状态数据直接 base64 放在 payload 里，别人可以轻易拿到数据，因此 JWT 要搭配 https
- 性能：相较于 cookie 保存的 id，JWT 的数据更多，请求的内容也会更多，所以 JWT 不要保存太多数据
- 没法让 JWT 失效：JWT 保存在客户端，没法手动失效，如踢人、退出登录。
- 一次失效：只能使用一次，每次都需要手动替换

**总结**

JWT 的方案是把状态数据保存在 header 里，每次请求都需要手动携带，没有 session + cookie 方案的三个问题，但是也有安全性、性能、没法控制失效的问题
